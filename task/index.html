<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SapiBersinar: Selesaikan Tugas</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K5JQPNMVEF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-K5JQPNMVEF'); // Your GA4 Measurement ID
    </script>

    <!-- SEO Meta Tags for SapiBersinar Task Page -->
    <meta name="description" content="Selesaikan tugas-tugas sederhana yang dibuat dengan SapiBersinar untuk membuka akses ke konten eksklusif atau tautan tujuan rahasia.">
    <meta name="keywords" content="selesaikan tugas, buka akses, konten eksklusif, tautan rahasia, SapiBersinar, verifikasi tugas, media sosial, ikuti, subscribe, bergabung">
    <meta name="author" content="SapiBersinar">
    <meta name="robots" content="noindex, follow"> <!-- noindex karena ini halaman unik per link -->

    <!-- Open Graph / Social Media Meta Tags (untuk berbagi di media sosial) -->
    <meta property="og:title" content="Selesaikan Tugas untuk Buka Akses di SapiBersinar">
    <meta property="og:description" content="Selesaikan tugas-tugas sederhana yang dibuat dengan SapiBersinar untuk membuka akses ke konten eksklusif atau tautan tujuan rahasia.">
    <meta property="og:url" content="https://sapibersinar.github.io/task/"> <!-- Perhatikan ini adalah URL dasar /task/ -->
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://placehold.co/1200x630/0d9488/ffffff?text=Selesaikan+Tugas"> <!-- Ganti dengan URL gambar logo/banner Anda -->
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Keyframes for Animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Animation for verification spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Animation for task completion highlight */
        @keyframes taskCompleteHighlight {
            0% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.5); } /* green-500 pulse */
            100% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }
        /* Dark theme version for task completion highlight */
        body.dark-theme .task-card.task-completed .checkmark-circle {
            background-color: #0d9488; /* teal-600 */
        }
        @keyframes taskCompleteHighlightDark {
            0% { box-shadow: 0 0 0 0px rgba(13, 148, 136, 0.5); } /* teal-600 pulse */
            100% { box-shadow: 0 0 0 8px rgba(13, 148, 136, 0); }
        }


        .animate-fade-in-down { animation: fadeInDown 1s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 1s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .spinner-animation { animation: spin 1.2s linear infinite; }
        .animate-task-complete-highlight-light { animation: taskCompleteHighlight 0.5s ease-out forwards; }
        .animate-task-complete-highlight-dark { animation: taskCompleteHighlightDark 0.5s ease-out forwards; }


        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for longer content */
            min-height: 100vh;
            padding: 2rem 1.5rem; /* Increased top/bottom padding */
            box-sizing: border-box;
            /* Default theme handled by JS, custom theme applied via JS */
        }
        /* Default themes (overridden by custom if set) */
        body.dark-theme {
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%); /* Darker, deep blue-gray gradient */
            color: #e2e8f0; /* gray-100 */
        }
        body.light-theme {
            background: linear-gradient(135deg, #f0fff4 0%, #e0ffe0 100%); /* Light pastel green gradient */
            color: #1a202c; /* gray-900 */
        }

        .main-card-container {
            border-radius: 1.75rem; /* rounded-3xl */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.08); /* Deep, layered shadow */
            padding: 2.5rem; /* Generous padding */
            max-width: 900px; /* Wider max width */
            width: 100%;
            text-align: center;
            border: 1px solid #e0e0e0; /* Subtle light border */
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; /* Smooth transition for theme change */
            animation: fadeIn 0.8s ease-out; /* Simple fade-in animation */
            position: relative;
            z-index: 2;
            /* Default colors, overridden by custom or theme */
        }
        body.light-theme .main-card-container {
            background-color: #fdfcf5; /* Very light, warm cream/off-white */
            border-color: #e0e0e0;
        }
        body.dark-theme .main-card-container {
            background-color: #34495e; /* Darker blue-gray */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3), 0 5px 15px rgba(0, 0, 0, 0.15); /* Darker shadow */
            border-color: #4a607a;
        }

        /* Button specific styles for theme (can be overridden by custom) */
        .btn-primary-dark {
            background: linear-gradient(to right, #8b5cf6, #6366f1); /* from-purple-600 to-indigo-600 */
            transition: all 0.3s ease;
        }
        .btn-primary-dark:hover {
            background: linear-gradient(to right, #7c3aed, #4f46e5); /* hover:from-purple-700 hover:to-indigo-700 */
            transform: scale(1.05);
        }
        .btn-primary-dark:disabled {
            background: #4a5568; /* gray-700 equivalent for disabled */
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        .btn-primary-light {
            background: linear-gradient(to right, #3b82f6, #14b8a6); /* from-blue-500 to-teal-500 */
            transition: all 0.3s ease;
        }
        .btn-primary-light:hover {
            background: linear-gradient(to right, #2563eb, #0d9488); /* hover:from-blue-600 hover:to-teal-600 */
            transform: scale(1.05);
        }
        .btn-primary-light:disabled {
            background: #a0aec0; /* gray-400 equivalent for disabled */
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        /* Task Card styles (can be overridden by custom) */
        .task-card {
            border-radius: 1rem; /* rounded-xl */
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            text-align: left;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; /* Ensure smooth color changes */
            border: 1px solid; /* Default border, theme sets color */
            position: relative; /* For checkmark positioning */
        }
        body.light-theme .task-card {
            background-color: #edf2f7; /* light gray */
            border-color: #e2e8f0;
        }
        body.dark-theme .task-card {
            background-color: #2c3e50; /* darker blue-gray */
            border-color: #4a607a;
        }
        .task-card.task-completed {
            border-color: #10b981; /* green-500 for completed border */
            box-shadow: 0 0 0 3px #10b981; /* Green glow for completed */
        }
        body.dark-theme .task-card.task-completed {
            border-color: #0d9488; /* teal-600 for dark theme completed border */
            box-shadow: 0 0 0 3px #0d9488;
        }


        /* Go to Task Button */
        .go-to-task-btn {
            background-color: #3b82f6; /* blue-500 */
            transition: all 0.2s ease;
        }
        .go-to-task-btn:hover:not(:disabled) {
            background-color: #2563eb; /* blue-600 */
            transform: translateY(-1px);
        }
        .go-to-task-btn:disabled {
            background-color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            opacity: 0.8;
            transform: none;
        }
        body.dark-theme .go-to-task-btn {
            background-color: #4f46e5; /* indigo-600 */
        }
        body.dark-theme .go-to-task-btn:hover:not(:disabled) {
            background-color: #4338ca; /* indigo-700 */
        }

        /* Checkmark and Spinner for tasks */
        .status-indicator-wrapper {
            position: relative;
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .spinner-icon {
            color: #6b7280; /* gray-500 */
            font-size: 1.25rem;
            position: absolute;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease-out;
        }
        body.dark-theme .spinner-icon {
            color: #9ca3af; /* gray-400 */
        }
        .checkmark-circle {
            position: absolute;
            background-color: #10b981; /* green-500 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: scale(0); /* Initially hidden */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0; /* Hidden by default */
        }
        .checkmark-circle.show {
            transform: scale(1);
            opacity: 1;
        }


        /* Toggle Button (copied from main page) */
        #darkModeToggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background-color: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 9999px;
            padding: 0.75rem;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            z-index: 10;
        }
        #darkModeToggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        body.dark-theme #darkModeToggle {
            background-color: #5A626F;
            color: #ecf0f1;
        }
        body.light-theme #darkModeToggle {
            background-color: #e0e0e0;
            color: #333;
        }

        /* Language Toggle Button (copied from main page) */
        #languageToggle {
            position: fixed;
            top: calc(1.5rem + 40px + 1rem);
            right: 1.5rem;
            background-color: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 9999px;
            padding: 0.75rem 0.85rem;
            min-width: 40px;
            min-height: 40px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            z-index: 10;
        }
        #languageToggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        body.dark-theme #languageToggle {
            background-color: #5A626F;
            color: #ecf0f1;
        }
        body.light-theme #languageToggle {
            background-color: #e0e0e0;
            color: #333;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0; /* light gray */
            border-radius: 9999px;
            height: 1rem; /* h-4 */
            overflow: hidden;
            margin-bottom: 0.5rem; /* mb-2 */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        body.dark-theme .progress-bar-container {
            background-color: #4a5568; /* gray-700 */
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #2563eb; /* blue-600 */
            border-radius: 9999px;
            transition: width 0.5s ease-out, background-color 0.3s ease;
        }
        body.dark-theme .progress-bar {
            background-color: #6366f1; /* indigo-500 */
        }
        .progress-text {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4a5568; /* gray-700 */
        }
        body.dark-theme .progress-text {
            color: #cbd5e0; /* gray-300 */
        }

        /* New: Container for multiple target buttons */
        #targetButtonsContainer {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap to next line */
            gap: 1rem; /* Spacing between buttons */
            justify-content: center; /* Center align buttons */
            margin-top: 2rem; /* Space from progress bar */
            margin-bottom: 2rem;
            animation: fadeIn 0.8s ease-out forwards; /* Fade in when shown */
        }

        .target-open-btn {
            flex: 1 1 auto; /* Allow buttons to grow and shrink, minimum size based on content */
            min-width: 180px; /* Minimum width for each button */
            max-width: calc(50% - 0.5rem); /* Max width for two columns on larger screens */
            padding: 1rem 1.5rem;
            text-align: center;
            font-size: 1.125rem; /* text-lg */
            font-weight: bold;
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            transform: scale(1);
            transition: all 0.3s ease;
        }

        .target-open-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .target-open-btn:disabled {
            background-color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        body.dark-theme .target-open-btn:disabled {
            background-color: #4a5568; /* gray-700 equivalent for disabled */
        }


        /* Responsive adjustments for smaller screens */
        @media (max-width: 640px) {
            body {
                padding: 1rem;
            }
            .main-card-container {
                padding: 1.5rem;
                border-radius: 1.25rem;
            }
            .title {
                font-size: 1.75rem;
            }
            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .task-item .flex-grow {
                width: 100%;
                margin-top: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .task-item button {
                width: 100%;
                margin-top: 0.5rem;
            }
            #darkModeToggle, #languageToggle {
                top: 1rem;
                right: 1rem;
                padding: 0.6rem;
                font-size: 1rem;
            }
            #languageToggle {
                top: calc(1rem + 32px + 0.5rem);
                right: 1rem;
                padding: 0.6rem 0.85rem;
                min-width: 32px;
                min-height: 32px;
                font-size: 0.9rem;
            }
            /* Adjust multi-target buttons for small screens */
            .target-open-btn {
                width: 100%; /* Full width on mobile */
                max-width: 100%;
            }
            #targetButtonsContainer {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body class="dark-theme"> <!-- Default to dark-theme -->

    <!-- Dark Mode Toggle Button -->
    <button id="darkModeToggle" aria-label="Toggle dark mode" title="Ubah Tema">
        <i class="fas fa-sun"></i> <!-- Icon will be dynamically changed by JS -->
    </button>

    <!-- Language Toggle Button -->
    <button id="languageToggle" aria-label="Toggle language" title="Ubah Bahasa">
        EN <!-- Text will be dynamically changed by JS -->
    </button>

    <!-- Custom Modal (Message Box) for validation errors and success messages) -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden animate-fade-in">
        <div id="modalContent" class="p-8 rounded-xl shadow-2xl max-w-sm w-full text-center how-it-works-card-dark transform scale-95 animate-scale-up">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4">Peringatan!</h3>
            <p id="modalMessage" class="text-lg mb-6">Pesan peringatan.</p>
            <button id="modalCloseBtn" class="px-6 py-3 rounded-full text-lg font-medium transition-all duration-300 transform hover:scale-105 btn-primary-dark">
                Tutup
            </button>
        </div>
    </div>

    <div id="mainContent" class="main-card-container">
        <h1 id="pageTitle" class="text-4xl font-extrabold mb-8 animate-fade-in-down"></h1>
        <!-- Subtitle removed as requested -->

        <div id="loadingMessage" class="text-lg opacity-80 animate-pulse" style="display: none;">
            Memuat tugas...
        </div>
        <div id="errorMessage" class="text-lg text-red-500 font-bold" style="display: none;">
            Terjadi kesalahan saat memuat tugas. Link mungkin tidak valid atau rusak, dan beberapa kemungkinan disebabkan pembaharuan pada website.
        </div>

        <!-- Task List Container -->
        <div id="tasksListContainer" class="space-y-4 mb-8">
            <!-- Tasks will be dynamically loaded here -->
        </div>

        <!-- Progress Bar and Indicator -->
        <div class="progress-bar-container mb-2">
            <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
        </div>
        <p id="tasksProgress" class="progress-text mb-8 animate-fade-in-up">
            0% Selesai (0 dari 0 tugas)
        </p>

        <!-- New: Container for target buttons -->
        <div id="targetButtonsContainer" class="hidden">
            <!-- Target buttons will be dynamically added here -->
        </div>

        <!-- SapiBersinar Promotion Section -->
        <div id="promotionSection" class="mt-12 p-6 rounded-xl shadow-md task-card animate-fade-in-up">
            <h2 id="promotionTitle" class="text-2xl font-bold mb-4">Buat Tugasmu Sendiri di SapiBersinar!</h2>
            <p id="promotionText" class="text-lg mb-6">
                Ingin punya halaman tugasmu sendiri untuk meningkatkan engagement atau mendapatkan pengikut?
                Gabung sekarang di SapiBersinar dan buat link unikmu hanya dalam hitungan menit!
            </p>
            <a id="promotionLink" href="https://SapiBersinar.github.io" target="_blank" class="w-full sm:w-auto inline-block px-8 py-3 rounded-full font-bold text-white shadow-lg transform transition-all duration-300 hover:scale-105 btn-primary-dark">
                <i class="fas fa-arrow-right mr-2"></i> <span id="promotionBtnText">Gabung Sekarang!</span>
            </a>
        </div>

    </div>

    <script>
        // DOM Elements
        const body = document.body;
        const mainCardContainer = document.getElementById('mainContent');
        const toggleLanguageBtn = document.getElementById('languageToggle');
        const toggleThemeBtn = document.getElementById('darkModeToggle');
        const themeIcon = toggleThemeBtn.querySelector('i');

        const pageTitle = document.getElementById('pageTitle');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const tasksListContainer = document.getElementById('tasksListContainer');
        const tasksProgress = document.getElementById('tasksProgress');
        const progressBar = document.getElementById('progressBar'); // Progress bar element
        
        const targetButtonsContainer = document.getElementById('targetButtonsContainer'); // New container for buttons

        const promotionTitle = document.getElementById('promotionTitle');
        const promotionText = document.getElementById('promotionText');
        const promotionLink = document.getElementById('promotionLink');
        const promotionBtnText = document.getElementById('promotionBtnText');
        const promotionSection = document.getElementById('promotionSection');

        const customModal = document.getElementById('customModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // Initial state
        let currentLanguage = 'id'; // Default to Indonesian
        let currentTheme = 'dark'; // Default to dark theme for consistency with create page

        let tasksData = null; // Will store parsed data from URL
        let completedTasksMap = {}; // Map to track completed tasks by their unique ID
        let completedCount = 0;
        let customizationOptions = {}; // Stores custom colors from URL

        // Store the keys for the currently displayed modal message
        let currentModalTitleKey = '';
        let currentModalMessageKey = '';

        // --- Custom Color Schemes - cohesive palettes for task page ---
        const customColorSchemes = {
            'default': {
                bodyBgLight: 'linear-gradient(135deg, #f0fff4 0%, #e0ffe0 100%)',
                bodyBgDark: 'linear-gradient(135deg, #2c3e50 0%, #1a252f 100%)',
                cardBgLight: '#fdfcf5',
                cardBgDark: '#34495e',
                textColorLight: '#1a202c',
                textColorDark: '#e2e8f0',
                btnGradientLight: 'linear-gradient(to right, #3b82f6, #14b8a6)',
                btnGradientDark: 'linear-gradient(to right, #8b5cf6, #6366f1)',
                cardBorderLight: '#e0e0e0',
                cardBorderDark: '#4a607a',
                progressBarLight: '#2563eb',
                progressBarDark: '#6366f1'
            },
            'modernBlue': {
                bodyBgLight: 'linear-gradient(135deg, #e0f7fa 0%, #b3e5fc 100%)',
                bodyBgDark: 'linear-gradient(135deg, #0d47a1 0%, #1a237e 100%)',
                cardBgLight: '#ffffff',
                cardBgDark: '#263238',
                textColorLight: '#263238',
                textColorDark: '#e3f2fd',
                btnGradientLight: 'linear-gradient(to right, #2196f3, #1976d2)',
                btnGradientDark: 'linear-gradient(to right, #64b5f6, #42a5f5)',
                cardBorderLight: '#90caf9',
                cardBorderDark: '#455a64',
                progressBarLight: '#2196f3',
                progressBarDark: '#42a5f5'
            },
            'energeticGreen': {
                bodyBgLight: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)',
                bodyBgDark: 'linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%)',
                cardBgLight: '#ffffff',
                cardBgDark: '#212121',
                textColorLight: '#333333',
                textColorDark: '#a5d6a7',
                btnGradientLight: 'linear-gradient(to right, #4caf50, #388e3c)',
                btnGradientDark: 'linear-gradient(to right, #81c784, #66bb6a)',
                cardBorderLight: '#a5d6a7',
                cardBorderDark: '#4caf50',
                progressBarLight: '#4caf50',
                progressBarDark: '#66bb6a'
            },
            'vibrantPurple': {
                bodyBgLight: 'linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%)',
                bodyBgDark: 'linear-gradient(135deg, #4a148c 0%, #6a1b9a 100%)',
                cardBgLight: '#ffffff',
                cardBgDark: '#311b92',
                textColorLight: '#4a148c',
                textColorDark: '#e0b2e8',
                btnGradientLight: 'linear-gradient(to right, #9c27b0, #7b1fa2)',
                btnGradientDark: 'linear-gradient(to right, #ce93d8, #ba68c8)',
                cardBorderLight: '#ce93d8',
                cardBorderDark: '#7b1fa2',
                progressBarLight: '#9c27b0',
                progressBarDark: '#ce93d8'
            },
            'warmRed': {
                bodyBgLight: 'linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%)',
                bodyBgDark: 'linear-gradient(135deg, #bf360c 0%, #e64a19 100%)',
                cardBgLight: '#ffffff',
                cardBgDark: '#3e2723',
                textColorLight: '#4e342e',
                textColorDark: '#ffccbc',
                btnGradientLight: 'linear-gradient(to right, #f44336, #d32f2f)',
                btnGradientDark: 'linear-gradient(to right, #ef9a9a, #e57373)',
                cardBorderLight: '#ffab91',
                cardBorderDark: '#d32f2f',
                progressBarLight: '#f44336',
                progressBarDark: '#e57373'
            },
            'coolGrey': {
                bodyBgLight: 'linear-gradient(135deg, #eceff1 0%, #cfd8dc 100%)',
                bodyBgDark: 'linear-gradient(135deg, #263238 0%, #37474f 100%)',
                cardBgLight: '#ffffff',
                cardBgDark: '#455a64',
                textColorLight: '#37474f',
                textColorDark: '#b0bec5',
                btnGradientLight: 'linear-gradient(to right, #607d8b, #455a64)',
                btnGradientDark: 'linear-gradient(to right, #90a4ae, #78909c)',
                cardBorderLight: '#90a4ae',
                cardBorderDark: '#607d8b',
                progressBarLight: '#607d8b',
                progressBarDark: '#78909c'
            }
        };

        // Content for different languages
        const content = {
            id: {
                // Dynamic pageTitle based on requiredTasks
                pageTitleTemplate: (count) => `Selesaikan Minimal ${count} Tugas untuk membuka tautan ekslusif`,
                loadingMessage: "Memuat tugas...",
                errorMessage: "Terjadi kesalahan saat memuat tugas. Link mungkin tidak valid atau rusak, dan beberapa kemungkinan disebabkan pembaharuan pada website.",
                tasksProgress: (completed, total, percentage) => `${percentage}% Selesai (${completed} dari ${total} tugas)`,
                
                openSingleContentText: "Buka Konten Kamu", // New
                openContentNText: "Buka Konten", // For "Buka Konten 1", "Buka Konten 2"
                goToTaskBtn: "Kunjungi Tugas",
                verifyingText: "Sedang verifikasi...", // Updated
                completedText: "Berhasil", // Updated
                modalWarningTitle: "Peringatan!",
                modalInvalidLink: `Mohon maaf, sepertinya terjadi masalah pada link ini. Ini bisa disebabkan oleh pembaruan website, link rusak, atau kesalahan lainnya. Pemilik link dimohon untuk membuat ulang link tugas ini.`,
                modalCompletionError: "Terjadi kesalahan saat menandai tugas. Silakan coba lagi.",
                modalClose: "Tutup",
                toggleLanguageText: "EN",
                toggleThemeTitle: "Ubah Tema",
                promotionTitle: "Buat Tugasmu Sendiri di SapiBersinar!",
                promotionText: `
                    Ingin punya halaman tugasmu sendiri untuk meningkatkan engagement atau mendapatkan pengikut?
                    Gabung sekarang di SapiBersinar dan buat link unikmu hanya dalam hitungan menit!
                `,
                promotionBtnText: "Gabung Sekarang!",
                // New: Task descriptions based on type and action
                taskDescriptions: {
                    youtube_subscribe: "Subscribe channel YouTube",
                    youtube_like: "Like video YouTube",
                    youtube_watch: "Tonton video YouTube",
                    roblox_follow: "Ikuti akun Roblox",
                    roblox_join: "Bergabung dengan grup Roblox",
                    tiktok_like: "Like video TikTok",
                    tiktok_follow: "Follow akun TikTok",
                    whatsapp_visit: "Kunjungi saluran WhatsApp", // Implicit action
                    discord_visit: "Gabung server Discord",     // Implicit action
                    blogger_visit: "Kunjungi postingan blog"   // Implicit action
                },
                // Helper function to get the correct task description string
                getTaskDescription: (type, action) => {
                    const key = `${type}_${action}`;
                    return content.id.taskDescriptions[key] || `Selesaikan tugas ${type}`; // Fallback to current language
                }
            },
            en: {
                pageTitleTemplate: (count) => `Complete At Least ${count} Tasks to Unlock Exclusive Link`,
                loadingMessage: "Loading tasks...",
                errorMessage: "An error occurred while loading tasks. The link might be invalid or corrupted, and some possibilities are due to website updates.",
                tasksProgress: (completed, total, percentage) => `${percentage}% Complete (${completed} of ${total} tasks)`,
                
                openSingleContentText: "Open Your Content", // New
                openContentNText: "Open Content", // For "Open Content 1", "Open Content 2"
                goToTaskBtn: "Visit Task",
                verifyingText: "Verifying...", // Updated
                completedText: "Success", // Updated
                modalWarningTitle: "Warning!",
                modalInvalidLink: `We apologize, it seems there's an issue with this link. This could be due to website updates, a corrupted link, or other errors. The link owner is kindly requested to recreate this task link.`,
                modalCompletionError: "An error occurred while marking task. Please try again.",
                modalClose: "Close",
                toggleLanguageText: "ID",
                toggleThemeTitle: "Toggle Theme",
                promotionTitle: "Create Your Own Tasks with SapiBersinar!",
                promotionText: `
                    Want to create your own task page to boost engagement or gain followers?
                    Join SapiBersinar now and create your unique links in minutes!
                `,
                promotionBtnText: "Join Now!",
                // New: Task descriptions based on type and action
                taskDescriptions: {
                    youtube_subscribe: "Subscribe YouTube channel",
                    youtube_like: "Like YouTube video",
                    youtube_watch: "Watch YouTube video",
                    roblox_follow: "Follow Roblox account",
                    roblox_join: "Join Roblox group",
                    tiktok_like: "Like TikTok video",
                    tiktok_follow: "Follow TikTok account",
                    whatsapp_visit: "Visit WhatsApp channel",
                    discord_visit: "Join Discord server",
                    blogger_visit: "Visit blog post"
                },
                // Helper function to get the correct task description string
                getTaskDescription: (type, action) => {
                    const key = `${type}_${action}`;
                    return content.en.taskDescriptions[key] || `Complete ${type} task`; // Fallback to current language
                }
            }
        };

        // Function to update content based on language
        function updateContent() {
            const currentLangContent = content[currentLanguage];

            // Update pageTitle dynamically here after tasksData is set
            if (tasksData) {
                pageTitle.textContent = currentLangContent.pageTitleTemplate(tasksData.requiredTasks);
            } else {
                // Default text before tasksData is loaded, or if there's an error
                pageTitle.textContent = currentLangContent.pageTitleTemplate(1); // Fallback to 1 if not loaded
            }

            loadingMessage.textContent = currentLangContent.loadingMessage;
            errorMessage.textContent = currentLangContent.errorMessage;
            
            promotionTitle.textContent = currentLangContent.promotionTitle;
            promotionText.innerHTML = currentLangContent.promotionText; // Use innerHTML for multi-line text
            promotionBtnText.textContent = currentLangContent.promotionBtnText;

            // Update language toggle button text and title
            toggleLanguageBtn.textContent = currentLangContent.toggleLanguageText;
            toggleLanguageBtn.title = currentLangContent.toggleLanguageText === 'EN' ? 'Switch to English' : 'Ubah ke Bahasa Indonesia';

            // Update theme toggle button title
            toggleThemeBtn.title = currentLangContent.toggleThemeTitle;

            // Re-render tasks to update button texts and descriptions
            if (tasksData && tasksData.tasks) {
                renderTasks(tasksData.tasks);
                updateProgress();
            }
            
            // Re-render target buttons if tasksData is ready
            if (tasksData && tasksData.targets) {
                renderTargetButtons(tasksData.targets);
                updateOpenButtonState(); // Update their enabled/disabled state and text
            }

            // IMPORTANT: If modal is open, re-render its content for language change
            if (!customModal.classList.contains('hidden') && currentModalTitleKey && currentModalMessageKey) {
                // Re-call showModal using the *keys* to get the translated version
                showModal(currentModalTitleKey, currentModalMessageKey);
            }
        }

        // Function to update theme classes and icon
        function updateTheme() {
            // Apply default theme to body and main card container
            body.classList.remove('dark-theme', 'light-theme');
            body.classList.add(`${currentTheme}-theme`);

            if (currentTheme === 'dark') {
                mainCardContainer.style.backgroundColor = '#34495e';
                mainCardContainer.style.borderColor = '#4a607a';
            } else {
                mainCardContainer.style.backgroundColor = '#fdfcf5';
                mainCardContainer.style.borderColor = '#e0e0e0';
            }

            // Update icon for theme toggle
            if (currentTheme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
            
            // Re-apply custom styles or default theme styles
            applyCustomStyles(true); // Always re-apply on theme change
        }

        // Function to apply custom styles based on parsed customizationOptions
        function applyCustomStyles(isThemeChange = false) {
            const mode = currentTheme; // 'light' or 'dark'
            const schemeName = customizationOptions.colorScheme || 'default';
            const scheme = customColorSchemes[schemeName];

            if (!scheme) {
                console.warn(`Color scheme '${schemeName}' not found. Falling back to default.`);
                return; // Exit if scheme not found
            }

            // --- Apply Page Background Color ---
            body.style.background = scheme.bodyBgLight && scheme.bodyBgDark ? scheme[`bodyBg${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';
            body.style.color = scheme.textColorLight && scheme.textColorDark ? scheme[`textColor${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';
            body.classList.remove('dark-theme', 'light-theme'); // Remove default theme classes as custom takes over

            // --- Apply Main Card Container Background Color ---
            mainCardContainer.style.backgroundColor = scheme.cardBgLight && scheme.cardBgDark ? scheme[`cardBg${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';
            mainCardContainer.style.borderColor = scheme.cardBorderLight && scheme.cardBorderDark ? scheme[`cardBorder${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';

            // --- Apply Task Card styles ---
            document.querySelectorAll('.task-card').forEach(card => {
                card.style.backgroundColor = scheme.cardBgLight && scheme.cardBgDark ? scheme[`cardBg${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';
                card.style.borderColor = scheme.cardBorderLight && scheme.cardBorderDark ? scheme[`cardBorder${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';
                card.classList.remove('dark-theme', 'light-theme'); // Ensure no lingering default theme classes
                // Re-apply completed border color if needed
                if (card.classList.contains('task-completed')) {
                    card.style.borderColor = (mode === 'dark' ? '#0d9488' : '#10b981'); /* specific green for completed */
                    card.style.boxShadow = `0 0 0 3px ${(mode === 'dark' ? '#0d9488' : '#10b981')}`;
                }
            });

            // --- Apply Main Text Color ---
            const mainContentElements = [pageTitle, tasksProgress, promotionTitle, promotionText];
            mainContentElements.forEach(el => {
                if (el) {
                    el.style.color = scheme.textColorLight && scheme.textColorDark ? scheme[`textColor${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';
                }
            });
            // Also apply to task descriptions (initial and status text)
            document.querySelectorAll('.task-initial-text, .task-status-text').forEach(textSpan => {
                textSpan.style.color = scheme.textColorLight && scheme.textColorDark ? scheme[`textColor${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';
            });


            // --- Apply Button Colors ---
            // Update promotion link button
            const promotionBtn = promotionLink;
            if (promotionBtn) {
                promotionBtn.classList.remove('btn-primary-dark', 'btn-primary-light');
                promotionBtn.style.background = '';
                if (scheme.btnGradientLight && scheme.btnGradientDark) {
                    promotionBtn.style.background = scheme[`btnGradient${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                } else {
                    promotionBtn.classList.add(`btn-primary-${currentTheme}`);
                }
            }

            // Update go-to-task-btn buttons
            document.querySelectorAll('.go-to-task-btn').forEach(btn => {
                btn.classList.remove('btn-primary-dark', 'btn-primary-light');
                btn.style.background = '';
                if (scheme.btnGradientLight && scheme.btnGradientDark) {
                    btn.style.background = scheme[`btnGradient${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                } else {
                    btn.classList.add(`btn-primary-${currentTheme}`);
                }
                // Re-apply disabled state after styling
                if (btn.disabled) {
                    btn.style.background = ''; // Clear custom gradient if disabled, let CSS handle
                    btn.style.backgroundColor = (mode === 'dark' ? '#4a5568' : '#a0aec0'); // Explicit disabled color
                }
            });

            // Update new target open buttons
            document.querySelectorAll('.target-open-btn').forEach(btn => {
                btn.classList.remove('btn-primary-dark', 'btn-primary-light'); // Remove default
                btn.style.background = ''; // Reset inline background style

                if (scheme.btnGradientLight && scheme.btnGradientDark) {
                    btn.style.background = scheme[`btnGradient${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                } else {
                    btn.classList.add(`btn-primary-${currentTheme}`); // Fallback
                }
                // Re-apply disabled state after styling
                if (btn.disabled) {
                    btn.style.background = ''; // Clear custom gradient if disabled, let CSS handle
                    btn.style.backgroundColor = (mode === 'dark' ? '#4a5568' : '#a0aec0'); // Explicit disabled color
                }
            });


            // Update progress bar color
            if (progressBar) {
                progressBar.style.backgroundColor = scheme.progressBarLight && scheme.progressBarDark ? scheme[`progressBar${mode.charAt(0).toUpperCase() + mode.slice(1)}`] : '';
            }

            // Update modal content background (this is static UI, uses default theme colors)
            if (currentTheme === 'dark') {
                modalContent.classList.add('dark-theme');
                modalContent.style.backgroundColor = '#2c3e50';
            } else {
                modalContent.classList.remove('dark-theme');
                modalContent.style.backgroundColor = '#edf2f7';
            }
        }

        // Function to show custom modal
        // Now accepts keys for messages instead of direct strings
        function showModal(titleKey, messageKey) {
            currentModalTitleKey = titleKey; // Store keys for language toggle
            currentModalMessageKey = messageKey; // Store keys for language toggle

            // Look up the actual message in the current language content
            modalTitle.textContent = content[currentLanguage][titleKey];
            modalMessage.innerHTML = content[currentLanguage][messageKey]; // Use innerHTML for line breaks

            customModal.classList.remove('hidden');
            // Ensure modal theme matches current theme
            if (currentTheme === 'dark') {
                modalContent.classList.add('dark-theme');
                modalContent.style.backgroundColor = '#2c3e50';
            } else {
                modalContent.classList.remove('dark-theme');
                modalContent.style.backgroundColor = '#edf2f7';
            }
        }

        // Function to render tasks dynamically
        function renderTasks(tasks) {
            tasksListContainer.innerHTML = ''; // Clear previous tasks

            tasks.forEach((task, index) => {
                const taskId = `task-${index}`;
                const isCompleted = completedTasksMap[taskId]; // Check if this specific task is completed

                const taskDiv = document.createElement('div');
                taskDiv.id = taskId;
                taskDiv.className = `task-card flex flex-col sm:flex-row items-center gap-4 transition-all duration-300 ${isCompleted ? 'task-completed' : ''}`;
                
                // Apply custom card colors if available, otherwise default theme
                const scheme = customColorSchemes[customizationOptions.colorScheme || 'default'];
                const mode = currentTheme;

                taskDiv.style.backgroundColor = scheme[`cardBg${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                taskDiv.style.borderColor = scheme[`cardBorder${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                taskDiv.classList.remove('dark-theme', 'light-theme'); // Remove default theme classes

                // Apply completed border color if already completed
                if (isCompleted) {
                    taskDiv.style.borderColor = (mode === 'dark' ? '#0d9488' : '#10b981'); /* specific green for completed */
                    taskDiv.style.boxShadow = `0 0 0 3px ${(mode === 'dark' ? '#0d9488' : '#10b981')}`;
                }

                // Task item structure
                taskDiv.innerHTML = `
                    <div class="flex items-center space-x-3 w-full sm:w-auto flex-grow">
                        <div class="status-indicator-wrapper">
                            <i class="fas fa-spinner spinner-icon ${isCompleted ? 'hidden' : ''}" style="opacity:0;"></i>
                            <div class="checkmark-circle ${isCompleted ? 'show' : ''}">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <span class="task-description text-lg font-semibold flex-grow text-left">
                            <span class="task-initial-text ${isCompleted ? 'hidden' : ''}">
                                ${content[currentLanguage].getTaskDescription(task.type, task.action)}
                            </span>
                            <span class="task-status-text ${isCompleted ? '' : 'hidden'}">
                                ${isCompleted ? content[currentLanguage].completedText : ''}
                            </span>
                        </span>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <button class="go-to-task-btn px-4 py-2 rounded-lg text-white font-semibold flex-1 ${isCompleted ? 'disabled' : ''}" ${isCompleted ? 'disabled' : ''}>
                            <i class="fas fa-external-link-alt mr-2"></i> ${content[currentLanguage].goToTaskBtn}
                        </button>
                    </div>
                `;
                tasksListContainer.appendChild(taskDiv);

                // Apply custom text color to task-description (both initial and status text)
                const taskInitialTextSpan = taskDiv.querySelector('.task-initial-text');
                const taskStatusTextSpan = taskDiv.querySelector('.task-status-text');

                if (taskInitialTextSpan) {
                     taskInitialTextSpan.style.color = scheme[`textColor${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                }
                if (taskStatusTextSpan) {
                     taskStatusTextSpan.style.color = scheme[`textColor${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                }

                // Apply custom button color to go-to-task-btn if set
                const goToTaskBtn = taskDiv.querySelector('.go-to-task-btn');
                if (goToTaskBtn) {
                    goToTaskBtn.classList.remove('btn-primary-dark', 'btn-primary-light'); // Remove default
                    goToTaskBtn.style.background = scheme[`btnGradient${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                    
                    // Re-apply disabled state after styling
                    if (goToTaskBtn.disabled) {
                        goToTaskBtn.style.background = ''; // Clear custom gradient if disabled, let CSS handle
                        goToTaskBtn.style.backgroundColor = (mode === 'dark' ? '#4a5568' : '#a0aec0'); // Explicit disabled color
                    }
                }

                // Add event listeners
                if (!isCompleted) { // Only add listener if not already completed
                    goToTaskBtn.addEventListener('click', () => {
                        handleTaskVisitAndVerification(taskId, goToTaskBtn, taskDiv, task.url);
                    });
                }
            });
        }

        // New function to render target buttons
        function renderTargetButtons(targets) {
            targetButtonsContainer.innerHTML = ''; // Clear existing buttons
            targetButtonsContainer.classList.remove('hidden'); // Ensure container is visible

            const scheme = customColorSchemes[customizationOptions.colorScheme || 'default'];
            const mode = currentTheme;

            targets.forEach((url, index) => {
                const btn = document.createElement('button');
                btn.className = `target-open-btn btn-primary-${currentTheme}`;
                
                if (targets.length === 1) {
                    btn.textContent = content[currentLanguage].openSingleContentText;
                } else {
                    btn.textContent = `${content[currentLanguage].openContentNText} ${index + 1}`;
                }
                
                btn.addEventListener('click', () => {
                    // No alert needed here as each button opens only one URL
                    window.open(url, '_blank');
                });
                targetButtonsContainer.appendChild(btn);

                // Apply custom gradient
                if (scheme.btnGradientLight && scheme.btnGradientDark) {
                    btn.style.background = scheme[`btnGradient${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                }
            });
            // Initial state will be set by updateOpenButtonState
            updateOpenButtonState();
        }


        // Function to handle task visit, verification, and completion
        function handleTaskVisitAndVerification(taskId, button, taskDiv, taskUrl) {
            if (completedTasksMap[taskId]) {
                return; // Already completed or verifying
            }

            // Temporarily disable the button
            button.disabled = true;
            button.classList.add('opacity-70', 'cursor-not-allowed');

            const taskInitialTextSpan = taskDiv.querySelector('.task-initial-text');
            const taskStatusTextSpan = taskDiv.querySelector('.task-status-text');
            const spinnerIcon = taskDiv.querySelector('.spinner-icon');
            const checkmarkCircle = taskDiv.querySelector('.checkmark-circle');

            // Hide initial text, show spinner and "Verifying..." text
            if (taskInitialTextSpan) taskInitialTextSpan.classList.add('hidden');
            if (taskStatusTextSpan) {
                taskStatusTextSpan.textContent = content[currentLanguage].verifyingText;
                taskStatusTextSpan.classList.remove('hidden');
            }
            if (spinnerIcon) {
                spinnerIcon.classList.remove('hidden');
                spinnerIcon.style.opacity = '1';
                spinnerIcon.classList.add('spinner-animation');
            }
            if (checkmarkCircle) checkmarkCircle.classList.remove('show'); // Hide checkmark if somehow visible

            // Open the task URL in a new tab immediately
            window.open(taskUrl, '_blank');

            // Simulate verification
            setTimeout(() => {
                // Hide spinner, show checkmark and "Completed" text
                if (spinnerIcon) {
                    spinnerIcon.classList.add('hidden');
                    spinnerIcon.style.opacity = '0';
                    spinnerIcon.classList.remove('spinner-animation');
                }
                if (checkmarkCircle) checkmarkCircle.classList.add('show');
                if (taskStatusTextSpan) {
                    taskStatusTextSpan.textContent = content[currentLanguage].completedText;
                    taskStatusTextSpan.classList.remove('hidden'); // Ensure it's visible
                }

                // Mark as completed
                completedTasksMap[taskId] = true;
                completedCount++;
                updateProgress();
                updateOpenButtonState(); // Call this to update button text/state

                // Apply visual completion styles
                taskDiv.classList.add('task-completed');
                taskDiv.classList.add(`animate-task-complete-highlight-${currentTheme}`);
                taskDiv.addEventListener('animationend', function handler() {
                    taskDiv.classList.remove(`animate-task-complete-highlight-${currentTheme}`);
                    taskDiv.removeEventListener('animationend', handler);
                }, { once: true });

                // Button permanently disabled after completion
                button.disabled = true;
                button.classList.remove('opacity-70', 'cursor-not-allowed'); // Remove temporary styles
            }, 15000); // 15 seconds verification time
        }

        // Function to update progress text and progress bar
        function updateProgress() {
            if (!tasksData) return;
            const totalTasks = tasksData.tasks.length;
            const percentage = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
            
            tasksProgress.textContent = content[currentLanguage].tasksProgress(completedCount, totalTasks, percentage);
            progressBar.style.width = `${percentage}%`;
        }

        // Function to enable/disable target buttons
        function updateOpenButtonState() {
            const targetOpenButtons = document.querySelectorAll('.target-open-btn');
            const scheme = customColorSchemes[customizationOptions.colorScheme || 'default'];
            const mode = currentTheme;

            if (!tasksData || completedCount < tasksData.requiredTasks) {
                targetOpenButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.background = ''; // Clear custom gradient if disabled
                    btn.style.backgroundColor = (mode === 'dark' ? '#4a5568' : '#a0aec0'); // Explicit disabled color
                });
            } else {
                targetOpenButtons.forEach(btn => {
                    btn.disabled = false;
                    // Re-apply custom gradient
                    if (scheme.btnGradientLight && scheme.btnGradientDark) {
                        btn.style.background = scheme[`btnGradient${mode.charAt(0).toUpperCase() + mode.slice(1)}`];
                    } else {
                        btn.classList.add(`btn-primary-${currentTheme}`); // Fallback
                    }
                });
            }
        }

        // Function to validate URL format
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Function to parse URL data
        function parseUrlData() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');

            if (!encodedData) {
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                // Pass content keys instead of direct strings
                showModal('modalWarningTitle', 'modalInvalidLink');
                return;
            }

            try {
                const decodedJson = atob(encodedData);
                tasksData = JSON.parse(decodedJson);

                // Extract customization options
                customizationOptions = tasksData.custom || {}; // Use empty object if custom is not present

                // Validate and ensure targets is an array of valid URLs
                if (!Array.isArray(tasksData.targets) || tasksData.targets.length === 0 || !tasksData.targets.every(isValidUrl)) {
                    throw new Error("Invalid or missing target URLs");
                }

                // Basic validation of parsed data structure for tasks
                if (!tasksData.buttonText || !Array.isArray(tasksData.tasks) || tasksData.requiredTasks === undefined) {
                    throw new Error("Invalid task data structure");
                }
                
                // Ensure requiredTasks is within bounds (at least 1, max total tasks)
                tasksData.requiredTasks = Math.max(1, Math.min(tasksData.requiredTasks, tasksData.tasks.length));

                loadingMessage.style.display = 'none';
                renderTasks(tasksData.tasks);
                renderTargetButtons(tasksData.targets); // Render the new target buttons
                updateProgress();
                updateOpenButtonState(); // Set button state after tasksData is ready

                // Apply custom styles immediately after parsing data
                applyCustomStyles();

                // Set dynamic page title after tasksData is parsed
                pageTitle.textContent = content[currentLanguage].pageTitleTemplate(tasksData.requiredTasks);

            } catch (e) {
                console.error("Error parsing task data:", e);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                // Pass content keys instead of direct strings
                showModal('modalWarningTitle', 'modalInvalidLink');
                // Set default page title if data parsing fails
                pageTitle.textContent = content[currentLanguage].pageTitleTemplate(1);
            }
        }

        // Event Listeners
        toggleLanguageBtn.addEventListener('click', () => {
            currentLanguage = currentLanguage === 'id' ? 'en' : 'id';
            updateContent();
        });

        toggleThemeBtn.addEventListener('click', () => {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            updateTheme(); // updateTheme now calls applyCustomStyles internally
        });

        modalCloseBtn.addEventListener('click', () => {
            customModal.classList.add('hidden');
        });

        // Initial setup
        loadingMessage.style.display = 'block'; // Show loading message initially
        // pageTitle is set here based on initial default, then updated by parseUrlData/updateContent
        pageTitle.textContent = content[currentLanguage].pageTitleTemplate(1); // Set a default value first
        updateContent(); // Set initial content texts
        updateTheme(); // Set initial theme and apply styles (will be re-applied after parseUrlData if custom options exist)
        parseUrlData(); // Parse data from URL and render tasks (will also call applyCustomStyles)
    </script>
</body>
</html>

