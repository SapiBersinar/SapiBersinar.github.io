<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkForge: Selesaikan Tugas</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Keyframes for Animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Animation for verification spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Animation for task completion highlight */
        @keyframes taskCompleteHighlight {
            0% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.5); } /* green-500 pulse */
            100% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }
        /* Dark theme version for task completion highlight */
        body.dark-theme .task-card.task-completed .checkmark-circle {
            background-color: #0d9488; /* teal-600 */
        }
        @keyframes taskCompleteHighlightDark {
            0% { box-shadow: 0 0 0 0px rgba(13, 148, 136, 0.5); } /* teal-600 pulse */
            100% { box-shadow: 0 0 0 8px rgba(13, 148, 136, 0); }
        }


        .animate-fade-in-down { animation: fadeInDown 1s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 1s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .spinner-animation { animation: spin 1.2s linear infinite; }
        .animate-task-complete-highlight-light { animation: taskCompleteHighlight 0.5s ease-out forwards; }
        .animate-task-complete-highlight-dark { animation: taskCompleteHighlightDark 0.5s ease-out forwards; }


        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for longer content */
            min-height: 100vh;
            padding: 2rem 1.5rem; /* Increased top/bottom padding */
            box-sizing: border-box;
            /* Default theme handled by JS, custom theme applied via JS */
        }
        /* Default themes (overridden by custom if set) */
        body.dark-theme {
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%); /* Darker, deep blue-gray gradient */
            color: #e2e8f0; /* gray-100 */
        }
        body.light-theme {
            background: linear-gradient(135deg, #f0fff4 0%, #e0ffe0 100%); /* Light pastel green gradient */
            color: #1a202c; /* gray-900 */
        }

        .main-card-container {
            border-radius: 1.75rem; /* rounded-3xl */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.08); /* Deep, layered shadow */
            padding: 2.5rem; /* Generous padding */
            max-width: 900px; /* Wider max width */
            width: 100%;
            text-align: center;
            border: 1px solid #e0e0e0; /* Subtle light border */
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; /* Smooth transition for theme change */
            animation: fadeIn 0.8s ease-out; /* Simple fade-in animation */
            position: relative;
            z-index: 2;
            /* Default colors, overridden by custom or theme */
        }
        body.light-theme .main-card-container {
            background-color: #fdfcf5; /* Very light, warm cream/off-white */
            border-color: #e0e0e0;
        }
        body.dark-theme .main-card-container {
            background-color: #34495e; /* Darker blue-gray */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3), 0 5px 15px rgba(0, 0, 0, 0.15); /* Darker shadow */
            border-color: #4a607a;
        }

        /* Button specific styles for theme (can be overridden by custom) */
        .btn-primary-dark {
            background: linear-gradient(to right, #8b5cf6, #6366f1); /* from-purple-600 to-indigo-600 */
            transition: all 0.3s ease;
        }
        .btn-primary-dark:hover {
            background: linear-gradient(to right, #7c3aed, #4f46e5); /* hover:from-purple-700 hover:to-indigo-700 */
            transform: scale(1.05);
        }
        .btn-primary-dark:disabled {
            background: #4a5568; /* gray-700 equivalent for disabled */
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        .btn-primary-light {
            background: linear-gradient(to right, #3b82f6, #14b8a6); /* from-blue-500 to-teal-500 */
            transition: all 0.3s ease;
        }
        .btn-primary-light:hover {
            background: linear-gradient(to right, #2563eb, #0d9488); /* hover:from-blue-600 hover:to-teal-600 */
            transform: scale(1.05);
        }
        .btn-primary-light:disabled {
            background: #a0aec0; /* gray-400 equivalent for disabled */
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        /* Task Card styles (can be overridden by custom) */
        .task-card {
            border-radius: 1rem; /* rounded-xl */
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            text-align: left;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; /* Ensure smooth color changes */
            border: 1px solid; /* Default border, theme sets color */
            position: relative; /* For checkmark positioning */
        }
        body.light-theme .task-card {
            background-color: #edf2f7; /* light gray */
            border-color: #e2e8f0;
        }
        body.dark-theme .task-card {
            background-color: #2c3e50; /* darker blue-gray */
            border-color: #4a607a;
        }
        .task-card.task-completed {
            border-color: #10b981; /* green-500 for completed border */
            box-shadow: 0 0 0 3px #10b981; /* Green glow for completed */
        }
        body.dark-theme .task-card.task-completed {
            border-color: #0d9488; /* teal-600 for dark theme completed border */
            box-shadow: 0 0 0 3px #0d9488;
        }


        /* Go to Task Button */
        .go-to-task-btn {
            background-color: #3b82f6; /* blue-500 */
            transition: all 0.2s ease;
        }
        .go-to-task-btn:hover:not(:disabled) {
            background-color: #2563eb; /* blue-600 */
            transform: translateY(-1px);
        }
        .go-to-task-btn:disabled {
            background-color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            opacity: 0.8;
            transform: none;
        }
        body.dark-theme .go-to-task-btn {
            background-color: #4f46e5; /* indigo-600 */
        }
        body.dark-theme .go-to-task-btn:hover:not(:disabled) {
            background-color: #4338ca; /* indigo-700 */
        }

        /* Checkmark and Spinner for tasks */
        .status-indicator-wrapper {
            position: relative;
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .spinner-icon {
            color: #6b7280; /* gray-500 */
            font-size: 1.25rem;
            position: absolute;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease-out;
        }
        body.dark-theme .spinner-icon {
            color: #9ca3af; /* gray-400 */
        }
        .checkmark-circle {
            position: absolute;
            background-color: #10b981; /* green-500 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: scale(0); /* Initially hidden */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0; /* Hidden by default */
        }
        .checkmark-circle.show {
            transform: scale(1);
            opacity: 1;
        }


        /* Toggle Button (copied from main page) */
        #darkModeToggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background-color: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 9999px;
            padding: 0.75rem;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            z-index: 10;
        }
        #darkModeToggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        body.dark-theme #darkModeToggle {
            background-color: #5A626F;
            color: #ecf0f1;
        }
        body.light-theme #darkModeToggle {
            background-color: #e0e0e0;
            color: #333;
        }

        /* Language Toggle Button (copied from main page) */
        #languageToggle {
            position: fixed;
            top: calc(1.5rem + 40px + 1rem);
            right: 1.5rem;
            background-color: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 9999px;
            padding: 0.75rem 0.85rem;
            min-width: 40px;
            min-height: 40px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            z-index: 10;
        }
        #languageToggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        body.dark-theme #languageToggle {
            background-color: #5A626F;
            color: #ecf0f1;
        }
        body.light-theme #languageToggle {
            background-color: #e0e0e0;
            color: #333;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0; /* light gray */
            border-radius: 9999px;
            height: 1rem; /* h-4 */
            overflow: hidden;
            margin-bottom: 0.5rem; /* mb-2 */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        body.dark-theme .progress-bar-container {
            background-color: #4a5568; /* gray-700 */
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #2563eb; /* blue-600 */
            border-radius: 9999px;
            transition: width 0.5s ease-out, background-color 0.3s ease;
        }
        body.dark-theme .progress-bar {
            background-color: #6366f1; /* indigo-500 */
        }
        .progress-text {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4a5568; /* gray-700 */
        }
        body.dark-theme .progress-text {
            color: #cbd5e0; /* gray-300 */
        }


        /* Responsive adjustments for smaller screens */
        @media (max-width: 640px) {
            body {
                padding: 1rem;
            }
            .main-card-container {
                padding: 1.5rem;
                border-radius: 1.25rem;
            }
            .title {
                font-size: 1.75rem;
            }
            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .task-item .flex-grow {
                width: 100%;
                margin-top: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .task-item button {
                width: 100%;
                margin-top: 0.5rem;
            }
            #darkModeToggle, #languageToggle {
                top: 1rem;
                right: 1rem;
                padding: 0.6rem;
                font-size: 1rem;
            }
            #languageToggle {
                top: calc(1rem + 32px + 0.5rem);
                right: 1rem;
                padding: 0.6rem 0.85rem;
                min-width: 32px;
                min-height: 32px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="dark-theme"> <!-- Default to dark-theme -->

    <!-- Dark Mode Toggle Button -->
    <button id="darkModeToggle" aria-label="Toggle dark mode" title="Ubah Tema">
        <i class="fas fa-sun"></i> <!-- Icon will be dynamically changed by JS -->
    </button>

    <!-- Language Toggle Button -->
    <button id="languageToggle" aria-label="Toggle language" title="Ubah Bahasa">
        EN <!-- Text will be dynamically changed by JS -->
    </button>

    <!-- Custom Modal (Message Box) for validation errors and success messages) -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden animate-fade-in">
        <div id="modalContent" class="p-8 rounded-xl shadow-2xl max-w-sm w-full text-center how-it-works-card-dark transform scale-95 animate-scale-up">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4">Peringatan!</h3>
            <p id="modalMessage" class="text-lg mb-6">Pesan peringatan.</p>
            <button id="modalCloseBtn" class="px-6 py-3 rounded-full text-lg font-medium transition-all duration-300 transform hover:scale-105 btn-primary-dark">
                Tutup
            </button>
        </div>
    </div>

    <div id="mainContent" class="main-card-container">
        <h1 id="pageTitle" class="text-4xl font-extrabold mb-8 animate-fade-in-down">Selesaikan Minimal 1 Tugas untuk membuka tautan ekslusif</h1>
        <!-- Subtitle removed as requested -->

        <div id="loadingMessage" class="text-lg opacity-80 animate-pulse" style="display: none;">
            Memuat tugas...
        </div>
        <div id="errorMessage" class="text-lg text-red-500 font-bold" style="display: none;">
            Terjadi kesalahan saat memuat tugas. Link mungkin tidak valid atau rusak.
        </div>

        <!-- Task List Container -->
        <div id="tasksListContainer" class="space-y-4 mb-8">
            <!-- Tasks will be dynamically loaded here -->
        </div>

        <!-- Progress Bar and Indicator -->
        <div class="progress-bar-container mb-2">
            <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
        </div>
        <p id="tasksProgress" class="progress-text mb-8 animate-fade-in-up">
            0% Selesai (0 dari 0 tugas)
        </p>

        <!-- Open Target Button -->
        <button id="openTargetBtn" class="w-full px-8 py-4 text-xl font-bold rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-opacity-75 btn-primary-dark" disabled>
            <span id="openTargetBtnText">Buka Konten Sekarang</span>
        </button>

        <!-- LinkForge Promotion Section -->
        <div id="promotionSection" class="mt-12 p-6 rounded-xl shadow-md task-card animate-fade-in-up">
            <h2 id="promotionTitle" class="text-2xl font-bold mb-4">Buat Tugasmu Sendiri di LinkForge!</h2>
            <p id="promotionText" class="text-lg mb-6">
                Ingin punya halaman tugasmu sendiri untuk meningkatkan engagement atau mendapatkan pengikut?
                Gabung sekarang di LinkForge dan buat link unikmu hanya dalam hitungan menit!
            </p>
            <a id="promotionLink" href="https://SapiBersinar.github.io" target="_blank" class="w-full sm:w-auto inline-block px-8 py-3 rounded-full font-bold text-white shadow-lg transform transition-all duration-300 hover:scale-105 btn-primary-dark">
                <i class="fas fa-arrow-right mr-2"></i> <span id="promotionBtnText">Gabung Sekarang!</span>
            </a>
        </div>

    </div>

    <script>
        // DOM Elements
        const body = document.body;
        const mainCardContainer = document.getElementById('mainContent');
        const toggleLanguageBtn = document.getElementById('languageToggle');
        const toggleThemeBtn = document.getElementById('darkModeToggle');
        const themeIcon = toggleThemeBtn.querySelector('i');

        const pageTitle = document.getElementById('pageTitle');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const tasksListContainer = document.getElementById('tasksListContainer');
        const tasksProgress = document.getElementById('tasksProgress');
        const progressBar = document.getElementById('progressBar'); // Progress bar element
        const openTargetBtn = document.getElementById('openTargetBtn');
        const openTargetBtnText = document.getElementById('openTargetBtnText');

        const promotionTitle = document.getElementById('promotionTitle');
        const promotionText = document.getElementById('promotionText');
        const promotionLink = document.getElementById('promotionLink');
        const promotionBtnText = document.getElementById('promotionBtnText');
        const promotionSection = document.getElementById('promotionSection');

        const customModal = document.getElementById('customModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // Initial state
        let currentLanguage = 'id'; // Default to Indonesian
        let currentTheme = 'dark'; // Default to dark theme for consistency with create page

        let tasksData = null; // Will store parsed data from URL
        let completedTasksMap = {}; // Map to track completed tasks by their unique ID
        let completedCount = 0;
        let customizationOptions = {}; // Stores custom colors from URL

        // --- Color Mappings ---
        const colorMap = {
            // Background Colors (for body/page and task cards)
            'blue': { light: '#e0f2fe', dark: '#1e3a8a' },
            'green': { light: '#ecfdf5', dark: '#047857' },
            'purple': { light: '#f3e8ff', dark: '#5b21b6' },
            'red': { light: '#fee2e2', dark: '#b91c1c' },
            'teal': { light: '#f0fdfa', dark: '#0f766e' },
            'indigo': { light: '#eef2ff', dark: '#3730a3' },

            // Text Colors
            'dark-text': { light: '#1a202c', dark: '#e2e8f0' }, // Standard light/dark text
            'light-text': { light: '#f8fafc', dark: '#f8fafc' }, // Always light text

            // Specific color texts (for overriding default dark/light text based on theme)
            'blue-text': { light: '#2563eb', dark: '#60a5fa' }, // Blue
            'green-text': { light: '#059669', dark: '#34d399' }, // Green
            'purple-text': { light: '#7c3aed', dark: '#a78bfa' }, // Purple
            'red-text': { light: '#dc2626', dark: '#f87171' }, // Red
            'teal-text': { light: '#0d9488', dark: '#2dd4bf' }, // Teal
            'indigo-text': { light: '#4f46e5', dark: '#818cf8' }, // Indigo
        };

        // --- Button Color Gradients ---
        // These are Tailwind-like gradient strings. The `applyCustomStyles` function will handle setting these.
        const btnGradientMap = {
            'blue-btn': { light: 'linear-gradient(to right, #3b82f6, #2563eb)', dark: 'linear-gradient(to right, #60a5fa, #3b82f6)' },
            'green-btn': { light: 'linear-gradient(to right, #10b981, #059669)', dark: 'linear-gradient(to right, #34d399, #10b981)' },
            'purple-btn': { light: 'linear-gradient(to right, #8b5cf6, #7c3aed)', dark: 'linear-gradient(to right, #a78bfa, #8b5cf6)' },
            'red-btn': { light: 'linear-gradient(to right, #ef4444, #dc2626)', dark: 'linear-gradient(to right, #f87171, #ef4444)' },
            'teal-btn': { light: 'linear-gradient(to right, #14b8a6, #0d9488)', dark: 'linear-gradient(to right, #2dd4bf, #14b8a6)' },
            'indigo-btn': { light: 'linear-gradient(to right, #6366f1, #4f46e5)', dark: 'linear-gradient(to right, #818cf8, #6366f1)' }
        };


        // Content for different languages
        const content = {
            id: {
                pageTitle: "Selesaikan Minimal 1 Tugas untuk membuka tautan ekslusif", // Updated
                loadingMessage: "Memuat tugas...",
                errorMessage: "Terjadi kesalahan saat memuat tugas. Link mungkin tidak valid atau rusak.",
                tasksProgress: (completed, total, percentage) => `${percentage}% Selesai (${completed} dari ${total} tugas)`, // Updated progress text
                openTargetBtnText: "Buka Konten Sekarang",
                goToTaskBtn: "Kunjungi Tugas",
                verifyingText: "Memverifikasi...", // New
                completedText: "Selesai",
                modalWarningTitle: "Peringatan!",
                modalInvalidLink: "Link tugas tidak valid atau rusak. Silakan periksa kembali URL.",
                modalCompletionError: "Terjadi kesalahan saat menandai tugas. Silakan coba lagi.",
                modalClose: "Tutup",
                toggleLanguageText: "EN",
                toggleThemeTitle: "Ubah Tema",
                promotionTitle: "Buat Tugasmu Sendiri di LinkForge!",
                promotionText: `
                    Ingin punya halaman tugasmu sendiri untuk meningkatkan engagement atau mendapatkan pengikut?
                    Gabung sekarang di LinkForge dan buat link unikmu hanya dalam hitungan menit!
                `,
                promotionBtnText: "Gabung Sekarang!",
                taskTypes: { // Specific phrases for task types
                    tiktok: "Ikuti akun Tiktok", // Updated
                    whatsapp: "Bergabung dengan saluran WhatsApp", // Updated
                    roblox: "Ikuti/gabung akun Roblox", // Updated
                    youtube: "Subscribe channel YouTube" // Updated
                }
            },
            en: {
                pageTitle: "Complete At Least 1 Task to Unlock Exclusive Link", // Updated
                loadingMessage: "Loading tasks...",
                errorMessage: "An error occurred while loading tasks. The link might be invalid or corrupted.",
                tasksProgress: (completed, total, percentage) => `${percentage}% Complete (${completed} of ${total} tasks)`, // Updated progress text
                openTargetBtnText: "Open Content Now",
                goToTaskBtn: "Visit Task",
                verifyingText: "Verifying...", // New
                completedText: "Completed",
                modalWarningTitle: "Warning!",
                modalInvalidLink: "Invalid or corrupted task link. Please check the URL.",
                modalCompletionError: "An error occurred while marking task. Please try again.",
                modalClose: "Close",
                toggleLanguageText: "ID",
                toggleThemeTitle: "Toggle Theme",
                promotionTitle: "Create Your Own Tasks with LinkForge!",
                promotionText: `
                    Want to create your own task page to boost engagement or gain followers?
                    Join LinkForge now and create your unique links in minutes!
                `,
                promotionBtnText: "Join Now!",
                taskTypes: { // This should match content from create page
                    tiktok: "Follow TikTok account", // Updated
                    whatsapp: "Join WhatsApp channel", // Updated
                    roblox: "Follow/join Roblox account", // Updated
                    youtube: "Subscribe YouTube channel" // Updated
                }
            }
        };

        // Function to update content based on language
        function updateContent() {
            const currentLangContent = content[currentLanguage];

            pageTitle.textContent = currentLangContent.pageTitle;
            loadingMessage.textContent = currentLangContent.loadingMessage;
            errorMessage.textContent = currentLangContent.errorMessage;
            openTargetBtnText.textContent = currentLangContent.openTargetBtnText;
            
            promotionTitle.textContent = currentLangContent.promotionTitle;
            promotionText.innerHTML = currentLangContent.promotionText; // Use innerHTML for multi-line text
            promotionBtnText.textContent = currentLangContent.promotionBtnText;

            // Update language toggle button text and title
            toggleLanguageBtn.textContent = currentLangContent.toggleLanguageText;
            toggleLanguageBtn.title = currentLangContent.toggleLanguageText === 'EN' ? 'Switch to English' : 'Ubah ke Bahasa Indonesia';

            // Update theme toggle button title
            toggleThemeBtn.title = currentLangContent.toggleThemeTitle;

            // Re-render tasks to update button texts and descriptions
            if (tasksData && tasksData.tasks) {
                renderTasks(tasksData.tasks);
                updateProgress();
            }
        }

        // Function to update theme classes and icon
        function updateTheme() {
            // Update body theme class (default theme handling)
            body.classList.remove('dark-theme', 'light-theme');
            body.classList.add(`${currentTheme}-theme`);

            // Update main card container theme class
            if (currentTheme === 'dark') {
                mainCardContainer.style.backgroundColor = '#34495e';
                mainCardContainer.style.borderColor = '#4a607a';
            } else {
                mainCardContainer.style.backgroundColor = '#fdfcf5';
                mainCardContainer.style.borderColor = '#e0e0e0';
            }

            // Update icon for theme toggle
            if (currentTheme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
            
            // Re-apply custom styles or default theme styles
            applyCustomStyles(true); // Always re-apply on theme change, but consider whether to animate (false for theme-only changes)
        }

        // Function to apply custom styles based on parsed customizationOptions
        function applyCustomStyles(isThemeChange = false) {
            const mode = currentTheme; // 'light' or 'dark'

            // --- Apply Page Background Color ---
            if (customizationOptions.bgColor && customizationOptions.bgColor !== 'default-theme') {
                const colorValue = colorMap[customizationOptions.bgColor][mode];
                body.style.background = colorValue ? colorValue : ''; // Use hex or specific gradient
                body.style.color = ''; // Reset body text color as it might be handled by textColor
                body.classList.remove('dark-theme', 'light-theme'); // Remove default theme classes
            } else {
                // If default, let updateTheme handle background & color
                body.classList.remove('custom-bg'); // Remove potential custom class
                body.classList.add(`${currentTheme}-theme`); // Re-apply default theme
            }

            // --- Apply Card Background Color ---
            document.querySelectorAll('.task-card').forEach(card => {
                if (customizationOptions.cardBgColor && customizationOptions.cardBgColor !== 'default-theme') {
                    const colorValue = colorMap[customizationOptions.cardBgColor][mode];
                    card.style.backgroundColor = colorValue ? colorValue : '';
                    card.style.borderColor = colorValue ? colorValue : ''; // Simple border color match
                    card.classList.remove('dark-theme', 'light-theme'); // Remove default theme classes
                } else {
                    // If default, let updateTheme handle
                    if (currentTheme === 'dark') {
                        card.classList.add('dark-theme');
                        card.style.backgroundColor = '#2c3e50';
                        card.style.borderColor = '#4a607a';
                    } else {
                        card.classList.remove('dark-theme');
                        card.style.backgroundColor = '#edf2f7';
                        card.style.borderColor = '#e2e8f0';
                    }
                }
            });

            // --- Apply Main Text Color ---
            // This is trickier as body.color applies to everything. Better to target specific elements if possible.
            // For simplicity, we'll try to apply to the main card container's direct children first,
            // then fall back to body if specific element targeting is too complex for general text.
            // For specific titles, we directly set color.
            const mainContentElements = [pageTitle, tasksProgress, promotionTitle, promotionText];
            mainContentElements.forEach(el => {
                if (el) { // Check if element exists
                    if (customizationOptions.textColor && customizationOptions.textColor !== 'default-theme') {
                        const className = customizationOptions.textColor;
                        // Remove all existing Tailwind text color classes (text-gray-*, text-blue-*)
                        el.classList.forEach(cls => {
                            if (cls.startsWith('text-')) {
                                el.classList.remove(cls);
                            }
                        });
                        // Add the new text color class or set inline style if it's a direct hex
                        const colorSpec = colorMap[className];
                        if (colorSpec) {
                            if (typeof colorSpec === 'string') { // It's a Tailwind class string
                                el.classList.add(colorSpec);
                            } else { // It's a hex value object
                                el.style.color = colorSpec[mode];
                            }
                        } else {
                            // Fallback to default theme colors if colorSpec not found
                            el.style.color = (currentTheme === 'dark' ? '#e2e8f0' : '#1a202c');
                        }
                    } else {
                         // Default theme for text color
                        el.style.color = ''; // Reset inline style
                        // Ensure default text classes are re-applied if theme changes
                        el.classList.forEach(cls => {
                            if (cls.startsWith('text-')) {
                                el.classList.remove(cls);
                            }
                        });
                         if (currentTheme === 'dark') {
                             el.classList.add('text-gray-100');
                         } else {
                             el.classList.add('text-gray-900');
                         }
                    }
                }
            });


            // --- Apply Button Colors ---
            const buttons = [openTargetBtn, promotionLink];
            document.querySelectorAll('.go-to-task-btn').forEach(btn => buttons.push(btn));

            buttons.forEach(btn => {
                if (btn) {
                    // Remove all existing btn-primary-* classes and inline styles
                    btn.classList.remove('btn-primary-dark', 'btn-primary-light');
                    btn.style.background = ''; // Reset inline background style

                    if (customizationOptions.btnColor && customizationOptions.btnColor !== 'default-theme') {
                        const gradient = btnGradientMap[customizationOptions.btnColor];
                        if (gradient) {
                            btn.style.background = gradient[mode];
                        } else {
                            // Fallback to default theme if custom button color not found
                            btn.classList.add(`btn-primary-${currentTheme}`);
                        }
                    } else {
                        // Default theme for buttons
                        btn.classList.add(`btn-primary-${currentTheme}`);
                    }
                    // Re-apply disabled state after styling
                    if (btn.disabled) {
                        btn.classList.add(currentTheme === 'dark' ? 'btn-primary-dark' : 'btn-primary-light');
                        btn.style.background = ''; // Reset inline if disabled
                        if (currentTheme === 'dark') {
                            btn.style.backgroundColor = '#4a5568';
                        } else {
                            btn.style.backgroundColor = '#a0aec0';
                        }
                    }
                }
            });
            // Update progress bar color
            if (progressBar) {
                if (customizationOptions.btnColor && customizationOptions.btnColor !== 'default-theme') {
                    // Assuming btnColor is a direct color name like 'blue', 'green'
                    const baseColorName = customizationOptions.btnColor.replace('-btn', ''); // e.g., 'blue' from 'blue-btn'
                    const progressBarColor = colorMap[baseColorName] ? colorMap[baseColorName][mode] : (currentTheme === 'dark' ? '#6366f1' : '#2563eb');
                    progressBar.style.backgroundColor = progressBarColor;
                } else {
                    // Default progress bar color
                    progressBar.style.backgroundColor = (currentTheme === 'dark' ? '#6366f1' : '#2563eb');
                }
            }

        }

        // Function to show custom modal
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
            // Ensure modal theme matches current theme
            // This is separate from applyCustomStyles because modal is fixed UI element
            if (currentTheme === 'dark') {
                modalContent.classList.add('dark-theme');
                modalContent.style.backgroundColor = '#2c3e50';
            } else {
                modalContent.classList.remove('dark-theme');
                modalContent.style.backgroundColor = '#edf2f7';
            }
        }

        // Function to render tasks dynamically
        function renderTasks(tasks) {
            tasksListContainer.innerHTML = ''; // Clear previous tasks

            tasks.forEach((task, index) => {
                const taskId = `task-${index}`;
                const isCompleted = completedTasksMap[taskId]; // Check if this specific task is completed

                const taskDiv = document.createElement('div');
                taskDiv.id = taskId;
                taskDiv.className = `task-card flex flex-col sm:flex-row items-center gap-4 transition-all duration-300 ${isCompleted ? 'task-completed' : ''}`;
                
                // Apply theme colors or custom card colors
                if (customizationOptions.cardBgColor && customizationOptions.cardBgColor !== 'default-theme') {
                    const colorValue = colorMap[customizationOptions.cardBgColor][currentTheme];
                    taskDiv.style.backgroundColor = colorValue ? colorValue : '';
                    taskDiv.style.borderColor = colorValue ? colorValue : '';
                } else {
                    // Default theme for task cards
                    if (currentTheme === 'dark') {
                        taskDiv.classList.add('dark-theme');
                        taskDiv.style.backgroundColor = '#2c3e50';
                        taskDiv.style.borderColor = '#4a607a';
                    } else {
                        taskDiv.classList.remove('dark-theme');
                        taskDiv.style.backgroundColor = '#edf2f7';
                        taskDiv.style.borderColor = '#e2e8f0';
                    }
                }
                // Apply completed border color if already completed
                if (isCompleted) {
                    if (currentTheme === 'dark') {
                        taskDiv.style.borderColor = '#0d9488'; /* teal-600 */
                        taskDiv.style.boxShadow = '0 0 0 3px #0d9488';
                    } else {
                        taskDiv.style.borderColor = '#10b981'; /* green-500 */
                        taskDiv.style.boxShadow = '0 0 0 3px #10b981';
                    }
                }

                // Task item structure
                taskDiv.innerHTML = `
                    <div class="flex items-center space-x-3 w-full sm:w-auto flex-grow">
                        <div class="status-indicator-wrapper">
                            <i class="fas fa-spinner spinner-icon ${isCompleted ? 'hidden' : ''}" style="opacity:0;"></i>
                            <div class="checkmark-circle ${isCompleted ? 'show' : ''}">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <span class="task-description text-lg font-semibold flex-grow text-left ${isCompleted ? 'line-through text-gray-500' : ''}">
                            ${content[currentLanguage].taskTypes[task.type] || task.type}
                        </span>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <button class="go-to-task-btn px-4 py-2 rounded-lg text-white font-semibold flex-1 ${isCompleted ? 'disabled' : ''}" ${isCompleted ? 'disabled' : ''}>
                            <i class="fas fa-external-link-alt mr-2"></i> ${content[currentLanguage].goToTaskBtn}
                        </button>
                    </div>
                `;
                tasksListContainer.appendChild(taskDiv);

                // Apply custom text color to task-description if set
                const taskDescriptionSpan = taskDiv.querySelector('.task-description');
                if (taskDescriptionSpan && customizationOptions.textColor && customizationOptions.textColor !== 'default-theme') {
                    const className = customizationOptions.textColor;
                    taskDescriptionSpan.classList.forEach(cls => {
                        if (cls.startsWith('text-')) {
                            taskDescriptionSpan.classList.remove(cls);
                        }
                    });
                    const colorSpec = colorMap[className];
                    if (colorSpec) {
                        if (typeof colorSpec === 'string') {
                            taskDescriptionSpan.classList.add(colorSpec);
                        } else {
                            taskDescriptionSpan.style.color = colorSpec[currentTheme];
                        }
                    }
                }


                // Apply custom button color to go-to-task-btn if set
                const goToTaskBtn = taskDiv.querySelector('.go-to-task-btn');
                if (goToTaskBtn) {
                    goToTaskBtn.classList.remove('btn-primary-dark', 'btn-primary-light'); // Remove default
                    goToTaskBtn.style.background = ''; // Reset inline background

                    if (customizationOptions.btnColor && customizationOptions.btnColor !== 'default-theme') {
                        const gradient = btnGradientMap[customizationOptions.btnColor];
                        if (gradient) {
                            goToTaskBtn.style.background = gradient[currentTheme];
                        } else {
                            // Fallback to default theme if custom button color not found
                            goToTaskBtn.classList.add(`btn-primary-${currentTheme}`);
                        }
                    } else {
                        // Default theme for buttons
                        goToTaskBtn.classList.add(`btn-primary-${currentTheme}`);
                    }
                    // Re-apply disabled state after styling
                    if (goToTaskBtn.disabled) {
                        goToTaskBtn.classList.remove(`btn-primary-${currentTheme}`); // Remove active style
                        if (currentTheme === 'dark') {
                            goToTaskBtn.style.backgroundColor = '#4a5568';
                        } else {
                            goToTaskBtn.style.backgroundColor = '#a0aec0';
                        }
                    }
                }


                // Add event listeners
                if (!isCompleted) { // Only add listener if not already completed
                    goToTaskBtn.addEventListener('click', () => {
                        handleTaskVisitAndVerification(taskId, goToTaskBtn, taskDiv, task.url);
                    });
                }
            });
        }

        // Function to handle task visit, verification, and completion
        function handleTaskVisitAndVerification(taskId, button, taskDiv, taskUrl) {
            if (completedTasksMap[taskId]) {
                return; // Already completed or verifying
            }

            // Temporarily disable the button
            button.disabled = true;
            button.classList.add('opacity-70', 'cursor-not-allowed');

            const taskDescriptionSpan = taskDiv.querySelector('.task-description');
            const spinnerIcon = taskDiv.querySelector('.spinner-icon');
            const checkmarkCircle = taskDiv.querySelector('.checkmark-circle');

            // Show spinner
            if (spinnerIcon) {
                spinnerIcon.classList.remove('hidden');
                spinnerIcon.style.opacity = '1';
                spinnerIcon.classList.add('spinner-animation');
            }
            if (checkmarkCircle) checkmarkCircle.classList.remove('show'); // Hide checkmark if somehow visible

            // Open the task URL in a new tab immediately
            window.open(taskUrl, '_blank');

            // Simulate verification
            setTimeout(() => {
                // Hide spinner, show checkmark
                if (spinnerIcon) {
                    spinnerIcon.classList.add('hidden');
                    spinnerIcon.style.opacity = '0';
                    spinnerIcon.classList.remove('spinner-animation');
                }
                if (checkmarkCircle) checkmarkCircle.classList.add('show');

                // Mark as completed
                completedTasksMap[taskId] = true;
                completedCount++;
                updateProgress();
                updateOpenButtonState();

                // Apply visual completion styles
                taskDiv.classList.add('task-completed');
                taskDiv.classList.add(`animate-task-complete-highlight-${currentTheme}`);
                taskDiv.addEventListener('animationend', function handler() {
                    taskDiv.classList.remove(`animate-task-complete-highlight-${currentTheme}`);
                    taskDiv.removeEventListener('animationend', handler);
                }, { once: true });

                // Add line-through to the task text when animation ends
                if (taskDescriptionSpan) {
                    taskDescriptionSpan.classList.add('line-through', 'text-gray-500');
                }

                // Button permanently disabled after completion
                button.disabled = true;
                button.classList.remove('opacity-70', 'cursor-not-allowed'); // Remove temporary styles
            }, 5500); // 5.5 seconds verification time
        }

        // Function to update progress text and progress bar
        function updateProgress() {
            if (!tasksData) return;
            const totalTasks = tasksData.tasks.length;
            const percentage = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
            
            tasksProgress.textContent = content[currentLanguage].tasksProgress(completedCount, totalTasks, percentage);
            progressBar.style.width = `${percentage}%`;
        }

        // Function to enable/disable open target button
        function updateOpenButtonState() {
            if (!tasksData) {
                openTargetBtn.disabled = true;
                return;
            }
            if (completedCount >= tasksData.requiredTasks) {
                openTargetBtn.disabled = false;
                openTargetBtn.classList.remove('btn-primary-dark'); // Remove disabled style if any
                openTargetBtn.classList.add(`btn-primary-${currentTheme}`); // Apply active style
                // If custom button color is set, apply that instead of default theme primary
                if (customizationOptions.btnColor && customizationOptions.btnColor !== 'default-theme') {
                    const gradient = btnGradientMap[customizationOptions.btnColor];
                    if (gradient) {
                        openTargetBtn.style.background = gradient[currentTheme];
                    }
                }
            } else {
                openTargetBtn.disabled = true;
                // Re-apply disabled style explicitly, which might overwrite custom background set earlier
                openTargetBtn.classList.remove(`btn-primary-${currentTheme}`); // Remove active style
                openTargetBtn.classList.add('btn-primary-dark'); // Default disabled style
                openTargetBtn.style.background = ''; // Clear custom gradient if disabled, let CSS handle
                openTargetBtn.style.backgroundColor = (currentTheme === 'dark' ? '#4a5568' : '#a0aec0'); // Explicit disabled color
            }
        }

        // Function to parse URL data
        function parseUrlData() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');

            if (!encodedData) {
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                showModal(content[currentLanguage].modalWarningTitle, content[currentLanguage].modalInvalidLink);
                return;
            }

            try {
                const decodedJson = atob(encodedData);
                tasksData = JSON.parse(decodedJson);

                // Extract customization options
                customizationOptions = tasksData.custom || {}; // Use empty object if custom is not present

                // Basic validation of parsed data structure
                if (!tasksData.target || !tasksData.buttonText || !Array.isArray(tasksData.tasks) || tasksData.requiredTasks === undefined) {
                    throw new Error("Invalid data structure");
                }
                
                // Ensure requiredTasks is within bounds (at least 1, max total tasks)
                tasksData.requiredTasks = Math.max(1, Math.min(tasksData.requiredTasks, tasksData.tasks.length));

                loadingMessage.style.display = 'none';
                renderTasks(tasksData.tasks);
                updateProgress();
                updateOpenButtonState();
                openTargetBtnText.textContent = tasksData.buttonText; // Set custom button text

                // Apply custom styles immediately after parsing data
                applyCustomStyles();

            } catch (e) {
                console.error("Error parsing task data:", e);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                showModal(content[currentLanguage].modalWarningTitle, content[currentLanguage].modalInvalidLink);
            }
        }

        // Event Listeners
        toggleLanguageBtn.addEventListener('click', () => {
            currentLanguage = currentLanguage === 'id' ? 'en' : 'id';
            updateContent();
        });

        toggleThemeBtn.addEventListener('click', () => {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            updateTheme(); // updateTheme now calls applyCustomStyles internally
        });

        openTargetBtn.addEventListener('click', () => {
            if (tasksData && completedCount >= tasksData.requiredTasks) {
                window.open(tasksData.target, '_blank');
            } else {
                // This scenario should ideally not happen if button is disabled, but good for fallback
                showModal(content[currentLanguage].modalWarningTitle, content[currentLanguage].tasksProgress(completedCount, tasksData.tasks.length, Math.round((completedCount / tasksData.tasks.length) * 100)) + ". " + content[currentLanguage].openTargetBtnText + ".");
            }
        });

        modalCloseBtn.addEventListener('click', () => {
            customModal.classList.add('hidden');
        });

        // Initial setup
        loadingMessage.style.display = 'block'; // Show loading message initially
        updateContent(); // Set initial content texts
        updateTheme(); // Set initial theme and apply styles (will be re-applied after parseUrlData if custom options exist)
        parseUrlData(); // Parse data from URL and render tasks (will also call applyCustomStyles)
    </script>
</body>
</html>

